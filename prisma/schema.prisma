generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider     = "postgresql"
  url = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id                    String                 @id @default(cuid())
  firstName             String
  lastName              String
  email                 String                 @unique
  emailVerified         DateTime?
  image                 String?
  password              String
  isTwoFactorEnabled    Boolean                @default(false)
  role                  UserRole               @default(USER)
  accounts              Account[]
  sessions              Session[]
  authenticator         Authenticator[]
  watchedHistory        WatchHistory[]
  downloads             Download[]
  subscriptions         Subscription[]
  playlistContents      PlaylistContent[]
  playlists             Playlist[]
  twoFactorConfirmation TwoFactorConfirmation?
  uploadFiles           UploadFile[]
  comments              Comment[]
  replies               Reply[]
  likes                 Like[]
  customer              Customer?
  contentRatings        ContentRating[]
  forums                Forum[]
  threads               Thread[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  oauth_token       String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([provider, providerAccountId])
  @@index([userId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model TwoFactorToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model TwoFactorConfirmation {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])
}

model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?
  user                 User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}

model Genre {
  id             String         @id @default(cuid())
  name           String
  series         Series[]

  @@map("genre")
}

model Cast {
  id          String       @id @default(cuid())
  name        String
  alsoKnownAs String?
  image       String
  dateOfBirth DateTime?
  gender      String
  height      String?
  weight      String?
  age         String
  region      String
  career      String
  bio         String?
  isFeatured  Boolean?     @default(false)
  seasonId    String
  season      Season       @relation(fields: [seasonId], references: [id], onUpdate: Restrict, onDelete: Restrict)
  uploadFiles UploadFile[]
  series      Series[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seasonId])
}

model UploadFile {
  id               String       @id @default(cuid())
  uuid             String
  originalFileName String
  mimeType         String
  size             Int
  cdnUrl           String
  isImage          Boolean      @default(false)
  width            Int
  height           Int
  uploadedAt       DateTime     @default(now())
  status           UploadStatus @default(PROCESSING)
  userId           String
  castId           String?
  episodeId        String?
  processedAt      DateTime?    @default(now())
  user             User         @relation(fields: [userId], references: [id])
  cast             Cast?        @relation(fields: [castId], references: [id])
  episode          Episode?     @relation(fields: [episodeId], references: [id])

  @@index([userId])
  @@index([castId])
  @@index([episodeId])
}

model Episode {
  id                String               @id @default(cuid())
  name              String
  description       String?
  releaseDate       DateTime?
  seasonId          String
  episodeNumber     Int?
  ageRatingId       String?
  ageRating         AgeRating?           @relation(fields: [ageRatingId], references: [id])
  contentLanguageId String?
  contentLanguage   ContentLanguage?     @relation(fields: [contentLanguageId], references: [id])
  contentWarnings   ContentWarningsType?
  videoUrl          String?
  subtitles         SubtitleTrack[]
  audioTrack        String?
  duration          Int?
  isPublished       Boolean?             @default(false)
  isFree            Boolean              @default(false)
  seriesId          String?
  season            Season               @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  muxData           MuxData?
  watchedHistory    WatchHistory[]
  download          Download[]
  series            Series?              @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  uploadFiles       UploadFile[]
  comments          Comment[]
  userProgress      UserProgress[]
  audioTracks       AudioTrack[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seasonId])
  @@index([seriesId])
  @@index([ageRatingId])
  @@index([contentLanguageId])
}

model Season {
  id                String    @id @default(cuid())
  name              String
  description       String?
  releaseDate       DateTime
  seasonNumber      String
  thumbnailImageUrl String?
  trailerVideoUrl   String?
  isPublished       Boolean   @default(false)
  seriesId          String
  series            Series    @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  regions           String?
  episodes          Episode[]
  casts             Cast[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([seriesId])
}

model AgeRating {
  id           String         @id @default(uuid())
  name         String         @unique
  episodes     Episode[]
  series       Series[]
  
  @@map("age_rating")
}

model ContentLanguage {
  id                String    @id @default(uuid())
  name              String    @unique
  isOrginalLanguage Boolean   @default(false)
  episodes          Episode[]
  series            Series[]
}

model ContentRating {
  id       String    @id @default(uuid())
  rating   Float     @unique @default(0)
  userId   String
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  series   Series[]

  @@index([userId])
}

model Comment {
  id        String  @id @default(cuid())
  content   String  @db.Text
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  episodeId String
  episode   Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  replies   Reply[]
  likes     Like[]
  threadId  String
  thread    Thread  @relation(fields: [threadId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([episodeId])
  @@index([threadId])
}

model Reply {
  id        String  @id @default(cuid())
  content   String  @db.Text
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  commentId String
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  likes     Like[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([commentId])
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  replyId   String?
  reply     Reply?   @relation(fields: [replyId], references: [id], onDelete: Cascade)
  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  threadId  String
  thread    Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@unique([userId, commentId, replyId])
  @@index([userId])
  @@index([replyId])
  @@index([commentId])
  @@index([threadId])
}

model Forum {
  id    String  @id @default(cuid())
  name  String
  image String?

  userId  String
  user    User     @relation(fields: [userId], references: [id])
  threads Thread[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Tags {
  id       String @id @default(uuid())
  threadId String
  thread   Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  name     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([threadId])
}

model Thread {
  id      String  @id @default(cuid())
  title   String
  content String  @db.Text
  fileUrl String? @db.Text

  userId   String
  user     User      @relation(fields: [userId], references: [id])
  tags     Tags[]
  forumId  String
  forum    Forum     @relation(fields: [forumId], references: [id], onDelete: Cascade)
  comments Comment[]
  likes    Like[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([forumId])
}

model Series {
  id                      String               @id @default(cuid())
  name                    String
  description             String?              @db.Text
  type                    ContentType?         @default(SERIES)
  duration                String?
  contentWarnings         ContentWarningsType? @default(ALCOHOL_USE)
  contentLanguageId       String?
  contentLanguage         ContentLanguage?     @relation(fields: [contentLanguageId], references: [id])
  isPublished             Boolean?             @default(false)
  isAvailableRegions      Boolean?             @default(false)
  viewsCount              Int?                 @default(0)
  contentRatingId         String?
  contentRating           ContentRating?       @relation(fields: [contentRatingId], references: [id], onDelete: Cascade)
  ageRatingId             String?
  ageRating               AgeRating?           @relation(fields: [ageRatingId], references: [id])
  releaseDate             DateTime?
  isNewRelease            Boolean?             @default(false)
  isPopular               Boolean?             @default(false)
  thumbnailImageUrl       String?
  bannerImageUrl          String?
  trailerVideoUrl         String?
  region                  String?
  starringCastDescription String?              @db.Text
  castDescription         String?              @db.Text
  isPaid                  Boolean?             @default(false)
  seasons                 Season[]
  episodes                Episode[]
  playlistId              String?
  playlist                Playlist?            @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  genreId                 String?
  genre                   Genre?               @relation(fields: [genreId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  watchHistoryId String?
  casts                   Cast[]
  playlistContent         PlaylistContent[]
  watchHistory            WatchHistory[]
  seriesBanners           SeriesBanner[]
  trailers                Trailers[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contentLanguageId])
  @@index([contentRatingId])
  @@index([playlistId])
  @@index([ageRatingId])
  @@index([genreId])
}

model Trailers {
  id                String          @id @default(uuid())
  name              String
  type              TrailersStatus? @default(TEASER)
  isPublished       Boolean?        @default(false)
  videoUrl          String?
  thumbnailImageUrl String?

  seriesId String?
  series   Series?  @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  muxData  MuxData?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seriesId])
}

model SeriesBanner {
  id             String              @id @default(cuid())
  name           String
  type           SeriesBannerType?   @default(IMAGE_BANNER)
  description    String?
  bannerImageUrl String?             @db.Text
  overlayText    String?
  ctaText        String?
  region         String?
  isAutoPlay     Boolean?            @default(false)
  status         SeriesBannerStatus? @default(ACTIVE)
  isPublished    Boolean?            @default(false)
  seriesId       String?
  series         Series?             @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seriesId])
}

model MuxData {
  id         String    @id @default(cuid())
  assetId    String
  playbackId String?
  episodeId  String?   @unique
  episode    Episode?  @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  trailerId  String?   @unique
  trailer    Trailers? @relation(fields: [trailerId], references: [id], onDelete: Cascade)

  subtitles   SubtitleTrack[]
  audioTracks AudioTrack[]
}

model SubtitleTrack {
  id            String   @id @default(uuid())
  muxTrackId    String?  @unique
  name          String
  languageCode  String
  url           String
  status        String
  autoGenerated Boolean  @default(false)
  episodeId     String
  episode       Episode  @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  muxDataId     String?
  muxData       MuxData? @relation(fields: [muxDataId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([episodeId])
  @@index([muxDataId])
}

model AudioTrack {
  id           String   @id @default(cuid())
  muxTrackId   String   @unique
  muxDataId    String?
  muxData      MuxData? @relation(fields: [muxDataId], references: [id], onDelete: Cascade)
  episodeId    String
  episode      Episode  @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  url          String?
  type         String // "primary" or "alternate"
  languageCode String // BCP-47 language tag (e.g., "en", "es", "fr")
  name         String // Display name (e.g., "English", "Espa√±ol")
  status       String   @default("preparing")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([muxDataId])
  @@index([episodeId])
}

model UserProgress {
  id     String @id @default(uuid())
  userId String

  episodeId String
  episode   Episode @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  isCompleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, episodeId])
  @@index([episodeId])
}

model Playlist {
  id            String            @id @default(cuid())
  name          String
  description   String?
  itemCount     Int?
  lastUpdatedAt DateTime          @default(now())
  userId        String
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  contents      PlaylistContent[]
  series        Series[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model PlaylistContent {
  id         String   @id @default(cuid())
  playlistId String
  seriesId   String
  series     Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  playlist   Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([playlistId, seriesId])
  @@index([playlistId])
  @@index([seriesId])
  @@index([userId])
}

model WatchHistory {
  id              String  @id @default(cuid())
  userId          String
  episodeId       String
  seriesId        String
  currentTime     Int     @default(0) // Current position in seconds
  duration        Int? // Video duration in seconds
  progressPercent Float   @default(0) // Progress percentage (0-100)
  isCompleted     Boolean @default(false)

  lastWatchedAt  DateTime @default(now())
  firstWatchedAt DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  episode        Episode  @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  series         Series   @relation(fields: [seriesId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, episodeId])
  @@index([userId, lastWatchedAt])
  @@index([userId])
  @@index([episodeId])
  @@index([seriesId])
}

model Download {
  id        String   @id @default(cuid())
  userId    String
  episodeId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  episode   Episode  @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  @@unique([userId, episodeId])
  @@index([userId])
  @@index([episodeId])
}

model WebhookEvent {
  id          String    @id @default(cuid())
  eventId     String    @unique // Polar's event.id (deduplication)
  type        String
  raw         Json // full payload
  processed   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([type])
  @@index([processed])
}

enum TrailersStatus {
  TRAILER
  TEASER
  CLIP
}

enum ContentRequestStatus {
  UNDER_REVIEW
  REJECTED
  APPROVED
  IN_DUBBING
  COMPLETED
}

enum SubtitleStatus {
  PENDING
  PROCESSING
  FAILED
  READY
}

enum SeriesBannerType {
  IMAGE_BANNER
  VIDEO_BANNER
}

enum SeriesBannerStatus {
  ACTIVE
  PAUSED
  SCHEDULED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
}

enum SubscriptionTier {
  FREE
  PREMIUM
  MAX
}

model Customer {
  id              String         @id @default(cuid())
  userId          String         @unique
  user            User           @relation(fields: [userId], references: [id])
  // Polar identifiers
  polarCustomerId String         @unique
  subscription    Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  // Polar specific fields
  polarSubscriptionId String @unique
  polarCustomerId     String
  productId           String

  status      String
  tier        SubscriptionTier @default(FREE)
  priceAmount Int // in cents
  currency    String           @default("USD")

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  cancelAt           DateTime?
  canceledAt         DateTime?

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([customerId])
}

enum UserRole {
  ADMIN
  USER
}

enum UploadStatus {
  PROCESSING @map("PROCESSING")
  COMPLETED
  STORED
}

enum ContentType {
  SERIES
  MOVIE
  DOCUMENTARY
  VARIETY_SHOWS
}

enum ContentWarningsType {
  VIOLENCE
  STRONG_LANGUAGE
  SEXUAL_CONTENT
  ALCOHOL_USE
  STRONG_SLANG
}
